#!/bin/bash

# Mirai Agent - ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð»ÐµÐ³ÐºÐ¾Ð²ÐµÑÐ½ÑƒÑŽ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ Ð¿Ð°Ð½ÐµÐ»Ð¸ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Mirai Agent..."
echo "==================================================="

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Python
if ! command -v python3 &> /dev/null; then
    echo "âŒ Python3 Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Python3 Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸Ñ."
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
mkdir -p "$PROJECT_ROOT/logs/monitoring"
mkdir -p "$PROJECT_ROOT/state"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."

DEPENDENCIES=(
    "fastapi"
    "uvicorn"
    "psutil"
    "httpx"
)

MISSING_DEPS=()

for dep in "${DEPENDENCIES[@]}"; do
    if ! python3 -c "import $dep" &> /dev/null; then
        MISSING_DEPS+=("$dep")
    fi
done

if [ ${#MISSING_DEPS[@]} -gt 0 ]; then
    echo "âš ï¸  Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°ÑŽÑ‰Ð¸Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸: ${MISSING_DEPS[*]}"
    pip3 install "${MISSING_DEPS[@]}"
fi

echo "âœ… Ð’ÑÐµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."

check_service() {
    local name=$1
    local url=$2
    local timeout=${3:-5}
    
    if curl -s --max-time $timeout "$url" > /dev/null 2>&1; then
        echo "âœ… $name - Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
        return 0
    else
        echo "âš ï¸  $name - Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ ($url)"
        return 1
    fi
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
check_service "Trading API" "http://localhost:8001/health" || true
check_service "Web API" "http://localhost:8000/health" || true
check_service "AI Orchestrator" "http://localhost:8080/health" || true

echo ""
echo "ðŸ–¥ï¸  Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð°Ð½ÐµÐ»Ð¸ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°..."

# ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 9999
if netstat -tlnp 2>/dev/null | grep -q ":9999 "; then
    echo "âš ï¸  ÐŸÐ¾Ñ€Ñ‚ 9999 Ð·Ð°Ð½ÑÑ‚. ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ..."
    pkill -f "simple_dashboard.py" || true
    sleep 2
fi

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
cd "$SCRIPT_DIR"

echo "ðŸŒ Ð—Ð°Ð¿ÑƒÑÐº Ð²ÐµÐ±-Ð¿Ð°Ð½ÐµÐ»Ð¸ Ð½Ð° http://localhost:9999"
echo "ðŸ“Š Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ°Ð¼: http://localhost:9999/metrics"
echo ""
echo "Ð”Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ctrl+C"
echo "================================================"

# Ð—Ð°Ð¿ÑƒÑÐº Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼
python3 simple_dashboard.py 2>&1 | tee "$PROJECT_ROOT/logs/monitoring/dashboard.log"