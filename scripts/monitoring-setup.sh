#!/bin/bash

# Mirai Monitoring System
# –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –∞–ª–µ—Ä—Ç–∞–º–∏

set -e

echo "üìä –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Mirai"

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Prometheus
setup_prometheus() {
    log "üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Prometheus..."
    
    mkdir -p /root/mirai-agent/monitoring/{prometheus,grafana,alertmanager}
    
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Prometheus
    cat > /root/mirai-agent/monitoring/prometheus/prometheus.yml << 'EOF'
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

scrape_configs:
  - job_name: 'mirai-ecosystem'
    static_configs:
      - targets: ['localhost:8001', 'localhost:8002']
    metrics_path: /metrics
    scrape_interval: 10s

  - job_name: 'mirai-system'
    static_configs:
      - targets: ['localhost:9100']
    
  - job_name: 'mirai-nginx'
    static_configs:
      - targets: ['localhost:9113']

  - job_name: 'mirai-postgres'
    static_configs:
      - targets: ['localhost:9187']

  - job_name: 'mirai-redis'
    static_configs:
      - targets: ['localhost:9121']
EOF

    # –ü—Ä–∞–≤–∏–ª–∞ –∞–ª–µ—Ä—Ç–æ–≤
    cat > /root/mirai-agent/monitoring/prometheus/alert_rules.yml << 'EOF'
groups:
  - name: mirai_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "–í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–æ–∫ –≤ API"
          description: "{{ $labels.job }} –∏–º–µ–µ—Ç {{ $value }} –æ—à–∏–±–æ–∫ –≤ —Å–µ–∫—É–Ω–¥—É"

      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "–í—ã—Å–æ–∫–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API"
          description: "95% –∫–≤–∞–Ω—Ç–∏–ª—å –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞: {{ $value }}s"

      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "–°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          description: "{{ $labels.job }} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "–í—ã—Å–æ–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ CPU"
          description: "CPU –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ {{ $value }}%"

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "–í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏"
          description: "–ü–∞–º—è—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ {{ $value }}%"

      - alert: DiskSpaceLow
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "–ú–∞–ª–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ"
          description: "–î–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω –Ω–∞ {{ $value }}%"
EOF

    log "‚úÖ Prometheus –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Alertmanager
setup_alertmanager() {
    log "üö® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Alertmanager..."
    
    cat > /root/mirai-agent/monitoring/alertmanager/alertmanager.yml << 'EOF'
global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@aimirai.online'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'

receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://localhost:8001/api/alerts'
        send_resolved: true

  - name: 'telegram'
    webhook_configs:
      - url: 'http://localhost:8001/api/telegram/alert'
        send_resolved: true
EOF

    log "‚úÖ Alertmanager –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Grafana
setup_grafana() {
    log "üìà –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Grafana..."
    
    # Datasources
    cat > /root/mirai-agent/monitoring/grafana/datasources.yml << 'EOF'
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    url: http://prometheus:9090
    isDefault: true
    access: proxy
EOF

    # Dashboard –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    cat > /root/mirai-agent/monitoring/grafana/dashboard.json << 'EOF'
{
  "dashboard": {
    "id": null,
    "title": "Mirai Ecosystem Dashboard",
    "tags": ["mirai"],
    "timezone": "browser",
    "panels": [
      {
        "id": 1,
        "title": "API Requests Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{endpoint}}"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
      },
      {
        "id": 2,
        "title": "Response Time",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95th percentile"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
      },
      {
        "id": 3,
        "title": "System Resources",
        "type": "graph",
        "targets": [
          {
            "expr": "100 - (avg(irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)",
            "legendFormat": "CPU Usage %"
          },
          {
            "expr": "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100",
            "legendFormat": "Memory Usage %"
          }
        ],
        "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8}
      }
    ],
    "time": {"from": "now-1h", "to": "now"},
    "refresh": "5s"
  }
}
EOF

    log "‚úÖ Grafana –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
}

# Docker Compose –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
create_monitoring_compose() {
    log "üê≥ –°–æ–∑–¥–∞–Ω–∏–µ Docker Compose –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
    
    cat > /root/mirai-agent/monitoring/docker-compose.monitoring.yml << 'EOF'
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: mirai-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus:/etc/prometheus
      - prometheus_data:/prometheus
    restart: unless-stopped

  alertmanager:
    image: prom/alertmanager:latest
    container_name: mirai-alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager:/etc/alertmanager
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: mirai-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml
    restart: unless-stopped

  node-exporter:
    image: prom/node-exporter:latest
    container_name: mirai-node-exporter
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($$|/)'
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    restart: unless-stopped

  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:latest
    container_name: mirai-nginx-exporter
    command:
      - '-nginx.scrape-uri=http://nginx:8080/nginx_status'
    ports:
      - "9113:9113"
    restart: unless-stopped

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: mirai-postgres-exporter
    environment:
      - DATA_SOURCE_NAME=postgresql://mirai:password@postgres:5432/mirai_production?sslmode=disable
    ports:
      - "9187:9187"
    restart: unless-stopped

  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: mirai-redis-exporter
    environment:
      - REDIS_ADDR=redis://redis:6379
    ports:
      - "9121:9121"
    restart: unless-stopped

volumes:
  prometheus_data:
  grafana_data:

networks:
  default:
    external:
      name: mirai-ecosystem
EOF

    log "‚úÖ Docker Compose –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ–∑–¥–∞–Ω"
}

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
create_monitoring_script() {
    log "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
    
    cat > /root/mirai-agent/scripts/start-monitoring.sh << 'EOF'
#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Mirai"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
cd /root/mirai-agent/monitoring

# –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
docker-compose -f docker-compose.monitoring.yml up -d

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
echo "–ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 30

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
check_service() {
    local service=$1
    local port=$2
    
    if curl -s http://localhost:$port > /dev/null; then
        echo "‚úÖ $service —Ä–∞–±–æ—Ç–∞–µ—Ç"
    else
        echo "‚ùå $service –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    fi
}

echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:"
check_service "Prometheus" "9090"
check_service "Grafana" "3000"
check_service "Alertmanager" "9093"
check_service "Node Exporter" "9100"

echo ""
echo "üéâ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω!"
echo "Grafana: http://localhost:3000 (admin/admin123)"
echo "Prometheus: http://localhost:9090"
echo "Alertmanager: http://localhost:9093"
EOF

    chmod +x /root/mirai-agent/scripts/start-monitoring.sh
    
    log "‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ —Å–æ–∑–¥–∞–Ω"
}

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API –¥–ª—è –º–µ—Ç—Ä–∏–∫
add_metrics_to_api() {
    log "üìä –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –≤ API..."
    
    cat > /root/mirai-agent/monitoring_middleware.py << 'EOF'
import time
import asyncio
from datetime import datetime
from typing import Dict, List
from fastapi import Request, Response
from prometheus_client import Counter, Histogram, Gauge, generate_latest, CONTENT_TYPE_LATEST
import psutil

# –ú–µ—Ç—Ä–∏–∫–∏ Prometheus
REQUEST_COUNT = Counter('http_requests_total', 'Total HTTP requests', ['method', 'endpoint', 'status'])
REQUEST_DURATION = Histogram('http_request_duration_seconds', 'HTTP request duration')
ACTIVE_CONNECTIONS = Gauge('active_connections', 'Active connections')
SYSTEM_CPU = Gauge('system_cpu_percent', 'CPU usage percentage')
SYSTEM_MEMORY = Gauge('system_memory_percent', 'Memory usage percentage')
SYSTEM_DISK = Gauge('system_disk_percent', 'Disk usage percentage')

class MonitoringMiddleware:
    def __init__(self, app):
        self.app = app
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –¥–ª—è —Å–±–æ—Ä–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
        asyncio.create_task(self.collect_system_metrics())
    
    async def __call__(self, scope, receive, send):
        if scope["type"] != "http":
            await self.app(scope, receive, send)
            return
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
        ACTIVE_CONNECTIONS.inc()
        
        start_time = time.time()
        request = Request(scope, receive)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
        response_sent = False
        
        async def send_wrapper(message):
            nonlocal response_sent
            if message["type"] == "http.response.start":
                response_sent = True
                status_code = message["status"]
                
                # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏
                duration = time.time() - start_time
                REQUEST_DURATION.observe(duration)
                REQUEST_COUNT.labels(
                    method=request.method,
                    endpoint=request.url.path,
                    status=status_code
                ).inc()
                
                ACTIVE_CONNECTIONS.dec()
            
            await send(message)
        
        await self.app(scope, receive, send_wrapper)
    
    async def collect_system_metrics(self):
        """–°–æ–±–∏—Ä–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥"""
        while True:
            try:
                # CPU
                cpu_percent = psutil.cpu_percent(interval=1)
                SYSTEM_CPU.set(cpu_percent)
                
                # Memory
                memory = psutil.virtual_memory()
                SYSTEM_MEMORY.set(memory.percent)
                
                # Disk
                disk = psutil.disk_usage('/')
                disk_percent = (disk.used / disk.total) * 100
                SYSTEM_DISK.set(disk_percent)
                
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫: {e}")
            
            await asyncio.sleep(15)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –≤ FastAPI
def add_metrics_endpoint(app):
    @app.get("/metrics")
    async def metrics():
        return Response(generate_latest(), media_type=CONTENT_TYPE_LATEST)
    
    @app.post("/api/alerts")
    async def receive_alert(alert_data: dict):
        """Endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–ª–µ—Ä—Ç–æ–≤ –æ—Ç Alertmanager"""
        print(f"–ü–æ–ª—É—á–µ–Ω –∞–ª–µ—Ä—Ç: {alert_data}")
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∫–∞–Ω–∞–ª—ã
        return {"status": "received"}

# Health check —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
def add_health_check(app):
    @app.get("/health/detailed")
    async def detailed_health():
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
            cpu_percent = psutil.cpu_percent()
            memory = psutil.virtual_memory()
            disk = psutil.disk_usage('/')
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            # (–¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –ë–î)
            
            return {
                "status": "healthy",
                "timestamp": datetime.now().isoformat(),
                "system": {
                    "cpu_percent": cpu_percent,
                    "memory_percent": memory.percent,
                    "disk_percent": (disk.used / disk.total) * 100,
                    "load_average": psutil.getloadavg() if hasattr(psutil, 'getloadavg') else None
                },
                "services": {
                    "api": "healthy",
                    "database": "checking...",  # –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ
                    "redis": "checking..."      # –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ
                }
            }
        except Exception as e:
            return {
                "status": "unhealthy",
                "error": str(e),
                "timestamp": datetime.now().isoformat()
            }
EOF

    log "‚úÖ Middleware –¥–ª—è –º–µ—Ç—Ä–∏–∫ —Å–æ–∑–¥–∞–Ω"
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    log "–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
    
    setup_prometheus
    setup_alertmanager
    setup_grafana
    create_monitoring_compose
    create_monitoring_script
    add_metrics_to_api
    
    log "üéâ –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≥–æ—Ç–æ–≤–∞!"
    log ""
    log "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
    log "1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: /root/mirai-agent/scripts/start-monitoring.sh"
    log "2. –û–±–Ω–æ–≤–∏—Ç–µ API –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫"
    log "3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –≤ Telegram"
    log "4. –î–æ—Å—Ç—É–ø –∫ Grafana: http://localhost:3000 (admin/admin123)"
}

# –ó–∞–ø—É—Å–∫
main