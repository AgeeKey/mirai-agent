#!/bin/bash

# Mirai Performance Optimization Script
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸

set -e

echo "âš¡ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Mirai Ecosystem"

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¼ÐµÑ‚Ñ€Ð¸Ðº ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
get_system_metrics() {
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
    local memory_usage=$(free | awk 'FNR==2{printf "%.1f", $3/($3+$4)*100}')
    local load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
    
    echo "CPU: ${cpu_usage}%, Memory: ${memory_usage}%, Load: ${load_avg}"
}

# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
optimize_system() {
    log "ðŸ”§ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²..."
    
    # ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² ÑÐ´Ñ€Ð°
    cat > /etc/sysctl.d/99-mirai-optimization.conf << 'EOF'
# Mirai Performance Optimization

# Network optimizations
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 16384 134217728
net.ipv4.tcp_wmem = 4096 65536 134217728
net.ipv4.tcp_congestion_control = bbr

# Memory optimizations
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# File system optimizations
fs.file-max = 2097152
EOF

    sysctl -p /etc/sysctl.d/99-mirai-optimization.conf
    
    log "âœ… Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹"
}

# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Docker
optimize_docker() {
    log "ðŸ³ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Docker..."
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Docker
    cat > /etc/docker/daemon.json << 'EOF'
{
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "10m",
        "max-file": "3"
    },
    "storage-driver": "overlay2",
    "storage-opts": [
        "overlay2.override_kernel_check=true"
    ],
    "experimental": true,
    "metrics-addr": "127.0.0.1:9323"
}
EOF

    # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Docker
    systemctl restart docker
    
    # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ñ€ÐµÑÑƒÑ€ÑÑ‹
    docker system prune -f
    
    log "âœ… Docker Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½"
}

# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
optimize_database() {
    log "ðŸ—„ï¸ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
    
    # Ð•ÑÐ»Ð¸ PostgreSQL Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½, Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼
    if docker ps | grep -q postgres; then
        docker exec -it mirai-postgres psql -U mirai -d mirai_production -c "VACUUM ANALYZE;"
        docker exec -it mirai-postgres psql -U mirai -d mirai_production -c "REINDEX DATABASE mirai_production;"
        log "âœ… PostgreSQL Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½"
    fi
    
    # Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ SQLite, Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼
    if [ -f "/root/mirai-agent/state/mirai.db" ]; then
        sqlite3 /root/mirai-agent/state/mirai.db "VACUUM;"
        sqlite3 /root/mirai-agent/state/mirai.db "REINDEX;"
        log "âœ… SQLite Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½"
    fi
}

# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€Ð°
optimize_web() {
    log "ðŸŒ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€Ð°..."
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ nginx
    cat > /root/mirai-agent/deployment/nginx-optimized.conf << 'EOF'
events {
    worker_connections 2048;
    use epoll;
    multi_accept on;
}

http {
    # Basic Settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    # Gzip Settings
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # Caching
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Rate Limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;

    # Main server configuration
    server {
        listen 80;
        server_name localhost;

        # API routes
        location /api/ {
            limit_req zone=api burst=20 nodelay;
            proxy_pass http://127.0.0.1:8001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Caching for API responses
            proxy_cache_valid 200 5m;
            proxy_cache_valid 404 1m;
        }

        # Frontend
        location / {
            limit_req zone=general burst=50 nodelay;
            proxy_pass http://127.0.0.1:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
EOF

    log "âœ… Ð’ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½"
}

# ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²
monitor_processes() {
    log "ðŸ“Š ÐÐ½Ð°Ð»Ð¸Ð· Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²..."
    
    # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹ Ñ Ð²Ñ‹ÑÐ¾ÐºÐ¸Ð¼ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸ÐµÐ¼ CPU
    local high_cpu_processes=$(ps aux --sort=-%cpu | head -10)
    echo "Ð¢Ð¾Ð¿ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð² Ð¿Ð¾ CPU:"
    echo "$high_cpu_processes"
    
    # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹ Ñ Ð²Ñ‹ÑÐ¾ÐºÐ¸Ð¼ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð¿Ð°Ð¼ÑÑ‚Ð¸
    local high_mem_processes=$(ps aux --sort=-%mem | head -10)
    echo "Ð¢Ð¾Ð¿ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð² Ð¿Ð¾ Ð¿Ð°Ð¼ÑÑ‚Ð¸:"
    echo "$high_mem_processes"
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð¾Ð¼Ð±Ð¸-Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹
    local zombie_count=$(ps aux | awk '$8 ~ /^Z/ { count++ } END { print count+0 }')
    if [ $zombie_count -gt 0 ]; then
        log "âš ï¸ ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ $zombie_count Ð·Ð¾Ð¼Ð±Ð¸-Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²"
    fi
}

# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹
optimize_applications() {
    log "ðŸ“± ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹..."
    
    # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸
    if docker ps | grep -q mirai-ecosystem-api; then
        docker restart mirai-ecosystem-api
        log "API Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
    fi
    
    # ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Node.js Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
    if pgrep -f "node.*trading" > /dev/null; then
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸
        export NODE_ENV=production
        export UV_THREADPOOL_SIZE=16
        export NODE_OPTIONS="--max-old-space-size=4096"
        log "Node.js Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½"
    fi
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
create_performance_report() {
    log "ðŸ“‹ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¾ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸..."
    
    local report_file="/root/mirai-agent/reports/performance_$(date +%Y%m%d_%H%M%S).json"
    
    cat > "$report_file" << EOF
{
    "timestamp": "$(date -Iseconds)",
    "system_metrics": {
        "cpu_usage": "$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')",
        "memory_usage": "$(free | awk 'FNR==2{printf "%.1f", $3/($3+$4)*100}')",
        "load_average": "$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')",
        "disk_usage": "$(df / | awk 'NR==2 {print $5}')",
        "network_connections": "$(netstat -an | wc -l)"
    },
    "docker_stats": {
        "containers_running": "$(docker ps --format 'table {{.Names}}' | wc -l)",
        "images_count": "$(docker images | wc -l)",
        "volumes_count": "$(docker volume ls | wc -l)"
    },
    "optimizations_applied": [
        "system_parameters",
        "docker_configuration",
        "database_optimization",
        "web_server_optimization"
    ]
}
EOF

    log "âœ… ÐžÑ‚Ñ‡ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½: $report_file"
}

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
main() {
    log "ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸..."
    log "Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸: $(get_system_metrics)"
    
    optimize_system
    optimize_docker
    optimize_database
    optimize_web
    monitor_processes
    optimize_applications
    create_performance_report
    
    log "ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸: $(get_system_metrics)"
    log "ðŸŽ‰ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
}

# Ð—Ð°Ð¿ÑƒÑÐº
main